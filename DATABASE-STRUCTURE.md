# üìã Estructura Completa de la Base de Datos - ShopUdenar Marketplace

## üéØ Contexto del Proyecto

Estoy desarrollando **ShopUdenar**, un marketplace/tienda en l√≠nea donde los usuarios pueden:
- Registrarse como vendedores y compradores
- Publicar art√≠culos para vender
- Comunicarse mediante chat
- Agregar productos al carrito
- Realizar compras
- Marcar favoritos
- Gestionar √≥rdenes de compra
- Calificar y rese√±ar productos y vendedores
- Recibir notificaciones en tiempo real
- Reportar productos o usuarios problem√°ticos

El backend est√° construido con:
- **NestJS** v11.0.1 (framework)
- **TypeORM** v0.3.27 (ORM)
- **PostgreSQL** v14.3 (base de datos)
- **TypeScript**
- **class-validator** (validaciones)
- **class-transformer** (transformaciones)

---

## üóÑÔ∏è ESTRUCTURA COMPLETA DE ENTIDADES

### üß© 1. **User** (Usuario)

Representa a los usuarios registrados. Cada usuario puede ser vendedor y comprador simult√°neamente.

**Atributos:**
```typescript
- id: UUID (PK, generado autom√°ticamente)
- name: string (nombre completo, min 3 caracteres)
- email: string (√∫nico, para autenticaci√≥n, validaci√≥n email)
- password: string (cifrada con bcrypt)
- phone: string (n√∫mero de contacto, nullable)
- avatarUrl: string (URL de imagen de perfil, nullable)
- role: enum { USER, ADMIN } (rol del usuario, default USER)
- address: string (direcci√≥n principal, nullable)
- isActive: boolean (cuenta activa, default true)
- rating: decimal(2, 1) (calificaci√≥n promedio como vendedor, 0.0-5.0, default 0.0)
- totalReviews: integer (cantidad de rese√±as recibidas como vendedor, default 0)
- createdAt: timestamp (autom√°tico)
- updatedAt: timestamp (autom√°tico)
```

**Relaciones:**
- `1:N` con **Product** (un usuario puede publicar muchos productos) ‚Üí `user.products`
- `1:1` con **Cart** (un usuario tiene un carrito) ‚Üí `user.cart`
- `1:N` con **Favorite** (un usuario puede tener muchos favoritos) ‚Üí `user.favorites`
- `1:N` con **Order** (un usuario puede realizar muchas √≥rdenes) ‚Üí `user.orders`
- `1:N` con **Chat** (como comprador o vendedor) ‚Üí `user.chatsAsBuyer`, `user.chatsAsSeller`
- `1:N` con **Message** (un usuario puede enviar muchos mensajes) ‚Üí `user.messages`
- `1:N` con **Review** (como autor de rese√±as) ‚Üí `user.reviewsGiven`
- `1:N` con **Review** (como vendedor rese√±ado) ‚Üí `user.reviewsReceived`
- `1:N` con **Notification** (un usuario recibe notificaciones) ‚Üí `user.notifications`
- `1:N` con **Report** (como reportador) ‚Üí `user.reportsCreated`
- `1:N` con **Report** (como reportado) ‚Üí `user.reportsReceived`

**√çndices:**
- Index en `email` (√∫nico)
- Index en `rating` (para b√∫squedas de mejores vendedores)

---

### üè∑Ô∏è 2. **Category** (Categor√≠a)

Clasificaci√≥n de productos (Electr√≥nica, Hogar, Ropa, Deportes, etc.)

**Atributos:**
```typescript
- id: UUID (PK)
- name: string (nombre de la categor√≠a, √∫nico, min 3 caracteres)
- slug: string (√∫nico, generado autom√°ticamente desde name)
- description: string (descripci√≥n opcional, nullable)
- iconUrl: string (URL del √≠cono de la categor√≠a, nullable)
- isActive: boolean (categor√≠a activa, default true)
- createdAt: timestamp (autom√°tico)
```

**Relaciones:**
- `1:N` con **Product** (una categor√≠a puede tener muchos productos) ‚Üí `category.products`

**Hooks:**
- `@BeforeInsert()`: Genera slug desde name
- `@BeforeUpdate()`: Actualiza slug si name cambi√≥

**√çndices:**
- Index en `slug` (√∫nico)

---

### üõí 3. **Product** (Producto) ‚úÖ **IMPLEMENTADA**

Art√≠culos que los usuarios publican para vender.

**Atributos:**
```typescript
- id: UUID (PK)
- title: string (√∫nico, min 3 caracteres)
- slug: string (√∫nico, generado autom√°ticamente desde title)
- description: string (nullable)
- price: decimal(12, 0) (pesos colombianos COP, sin decimales, positivo)
- condition: enum { NEW, USED } (estado del producto)
- images: string[] (array de URLs)
- stock: integer (cantidad disponible, min 1, default 1)
- isSold: boolean (default false)
- rating: decimal(2, 1) (calificaci√≥n promedio del producto, 0.0-5.0, default 0.0) [PENDIENTE]
- totalReviews: integer (cantidad de rese√±as del producto, default 0) [PENDIENTE]
- viewsCount: integer (contador de vistas, default 0) [PENDIENTE]
- createdAt: timestamp (autom√°tico)
- updatedAt: timestamp (autom√°tico)
- sellerId: UUID (FK ‚Üí User) [PENDIENTE]
- categoryId: UUID (FK ‚Üí Category) [PENDIENTE]
```

**Relaciones:**
- `N:1` con **User** (muchos productos pertenecen a un vendedor) ‚Üí `product.seller`
- `N:1` con **Category** (muchos productos pertenecen a una categor√≠a) ‚Üí `product.category`
- `1:N` con **Favorite** (un producto puede estar en muchos favoritos)
- `1:N` con **CartItem** (un producto puede estar en muchos carritos)
- `1:N` con **OrderItem** (un producto puede estar en muchas √≥rdenes)
- `1:N` con **Chat** (un producto puede tener varios chats)
- `1:N` con **Review** (un producto puede tener muchas rese√±as) ‚Üí `product.reviews`
- `1:N` con **Report** (un producto puede ser reportado) ‚Üí `product.reports`

**Hooks:**
- `@BeforeInsert()`: Genera slug desde title si no existe ‚úÖ
- `@BeforeUpdate()`: Normaliza el slug si fue modificado ‚úÖ

**√çndices:**
- Index en `slug` (√∫nico) ‚úÖ
- Index en `sellerId`
- Index en `categoryId`
- Index en `rating` (para b√∫squedas de mejor calificados)
- Index en `createdAt` (para ordenar por fecha)

**Estado actual:**
- ‚úÖ Entidad completamente implementada
- ‚úÖ DTOs creados (CreateProductDto, UpdateProductDto)
- ‚úÖ Service implementado (CRUD completo)
- ‚úÖ Controller con endpoints REST
- ‚úÖ Paginaci√≥n implementada (limit, offset)
- ‚úÖ Validaciones con class-validator
- ‚úÖ Seed module con 15 productos iniciales
- ‚úÖ Precios en pesos colombianos (COP)
- ‚úÖ B√∫squeda por UUID o slug

---

### üß∫ 4. **Cart** (Carrito)

Carrito de compras activo de cada usuario.

**Atributos:**
```typescript
- id: UUID (PK)
- userId: UUID (FK ‚Üí User, √∫nico)
- createdAt: timestamp (autom√°tico)
- updatedAt: timestamp (autom√°tico)
```

**Relaciones:**
- `1:1` con **User** (un carrito pertenece a un usuario) ‚Üí `cart.user`
- `1:N` con **CartItem** (un carrito contiene muchos √≠tems) ‚Üí `cart.items`

**√çndices:**
- Index en `userId` (√∫nico)

---

### üì¶ 5. **CartItem** (Item de Carrito)

Productos espec√≠ficos dentro de un carrito.

**Atributos:**
```typescript
- id: UUID (PK)
- cartId: UUID (FK ‚Üí Cart)
- productId: UUID (FK ‚Üí Product)
- quantity: integer (cantidad, min 1, default 1)
- createdAt: timestamp (autom√°tico)
```

**Relaciones:**
- `N:1` con **Cart** (muchos items pertenecen a un carrito) ‚Üí `cartItem.cart`
- `N:1` con **Product** (muchos items se asocian a un producto) ‚Üí `cartItem.product`

**Constraints:**
- Unique constraint en `(cartId, productId)` ‚Üí Un producto solo puede estar una vez en el mismo carrito

**√çndices:**
- Composite index en `(cartId, productId)` (√∫nico)

---

### üí∞ 6. **Order** (Orden de Compra)

Compra confirmada por un usuario.

**Atributos:**
```typescript
- id: UUID (PK)
- orderNumber: string (n√∫mero de orden √∫nico generado, ej: "ORD-20251018-00001")
- buyerId: UUID (FK ‚Üí User)
- totalAmount: decimal(12, 0) (monto total en COP)
- status: enum { PENDING, PAID, CANCELLED, SHIPPED, DELIVERED }
- paymentMethod: enum { CASH, CARD, TRANSFER }
- shippingAddress: string (direcci√≥n de env√≠o)
- notes: text (notas adicionales del comprador, nullable)
- createdAt: timestamp (autom√°tico)
- updatedAt: timestamp (autom√°tico)
```

**Relaciones:**
- `N:1` con **User** (muchas √≥rdenes pertenecen a un comprador) ‚Üí `order.buyer`
- `1:N` con **OrderItem** (una orden contiene muchos items) ‚Üí `order.items`

**Hooks:**
- `@BeforeInsert()`: Genera orderNumber √∫nico

**√çndices:**
- Index en `orderNumber` (√∫nico)
- Index en `buyerId`
- Index en `status`
- Index en `createdAt`

---

### üßæ 7. **OrderItem** (Item de Orden)

Productos dentro de una orden (snapshot hist√≥rico del precio).

**Atributos:**
```typescript
- id: UUID (PK)
- orderId: UUID (FK ‚Üí Order)
- productId: UUID (FK ‚Üí Product)
- sellerId: UUID (FK ‚Üí User) (vendedor en el momento de la compra)
- quantity: integer (cantidad comprada, min 1)
- price: decimal(12, 0) (precio unitario en el momento de la compra)
- productTitle: string (t√≠tulo del producto en el momento de compra)
- createdAt: timestamp (autom√°tico)
```

**Relaciones:**
- `N:1` con **Order** (muchos items pertenecen a una orden) ‚Üí `orderItem.order`
- `N:1` con **Product** (muchos items se asocian a un producto) ‚Üí `orderItem.product`
- `N:1` con **User** (muchos items son vendidos por un usuario) ‚Üí `orderItem.seller`

**Importante:** 
- Se guarda el precio, t√≠tulo y vendedor en el momento de la compra para mantener historial preciso
- Permite generar reportes de ventas por vendedor

**√çndices:**
- Index en `orderId`
- Index en `productId`
- Index en `sellerId`

---

### ‚ù§Ô∏è 8. **Favorite** (Favorito)

Productos marcados como favoritos por los usuarios.

**Atributos:**
```typescript
- id: UUID (PK)
- userId: UUID (FK ‚Üí User)
- productId: UUID (FK ‚Üí Product)
- createdAt: timestamp (autom√°tico)
```

**Relaciones:**
- `N:1` con **User** (muchos favoritos pertenecen a un usuario) ‚Üí `favorite.user`
- `N:1` con **Product** (muchos favoritos se asocian a un producto) ‚Üí `favorite.product`

**Constraints:**
- Unique constraint en `(userId, productId)` ‚Üí Un usuario no puede marcar el mismo producto como favorito dos veces

**√çndices:**
- Composite index en `(userId, productId)` (√∫nico)

---

### üí¨ 9. **Chat** (Chat)

Conversaci√≥n entre comprador y vendedor sobre un producto.

**Atributos:**
```typescript
- id: UUID (PK)
- buyerId: UUID (FK ‚Üí User)
- sellerId: UUID (FK ‚Üí User)
- productId: UUID (FK ‚Üí Product)
- lastMessageAt: timestamp (fecha del √∫ltimo mensaje, nullable)
- isActive: boolean (chat activo, default true)
- createdAt: timestamp (autom√°tico)
```

**Relaciones:**
- `N:1` con **User** (como comprador) ‚Üí `chat.buyer`
- `N:1` con **User** (como vendedor) ‚Üí `chat.seller`
- `N:1` con **Product** (chat asociado a un producto) ‚Üí `chat.product`
- `1:N` con **Message** (un chat tiene muchos mensajes) ‚Üí `chat.messages`

**Constraints:**
- Unique constraint en `(buyerId, sellerId, productId)` ‚Üí Solo un chat por producto entre los mismos usuarios
- Check constraint: `buyerId != sellerId` ‚Üí No se puede chatear consigo mismo

**√çndices:**
- Composite index en `(buyerId, sellerId, productId)` (√∫nico)
- Index en `lastMessageAt`

---

### ‚úâÔ∏è 10. **Message** (Mensaje)

Mensajes intercambiados dentro de un chat.

**Atributos:**
```typescript
- id: UUID (PK)
- chatId: UUID (FK ‚Üí Chat)
- senderId: UUID (FK ‚Üí User)
- content: text (contenido del mensaje, max 2000 caracteres)
- isRead: boolean (mensaje le√≠do, default false)
- createdAt: timestamp (autom√°tico)
```

**Relaciones:**
- `N:1` con **Chat** (muchos mensajes pertenecen a un chat) ‚Üí `message.chat`
- `N:1` con **User** (muchos mensajes pertenecen a un emisor) ‚Üí `message.sender`

**Hooks:**
- `@AfterInsert()`: Actualiza `lastMessageAt` en Chat

**√çndices:**
- Index en `chatId`
- Index en `senderId`
- Index en `createdAt`

---

### ‚≠ê 11. **Review** (Rese√±a/Calificaci√≥n)

Calificaciones y comentarios sobre productos o vendedores.

**Atributos:**
```typescript
- id: UUID (PK)
- userId: UUID (FK ‚Üí User, autor de la rese√±a)
- productId: UUID (FK ‚Üí Product, nullable)
- sellerId: UUID (FK ‚Üí User, nullable)
- orderItemId: UUID (FK ‚Üí OrderItem, nullable, √∫nico)
- rating: integer (calificaci√≥n 1-5)
- comment: text (comentario opcional, max 1000 caracteres, nullable)
- type: enum { PRODUCT, SELLER } (tipo de rese√±a)
- createdAt: timestamp (autom√°tico)
- updatedAt: timestamp (autom√°tico)
```

**Relaciones:**
- `N:1` con **User** (autor) ‚Üí `review.user`
- `N:1` con **Product** (producto rese√±ado) ‚Üí `review.product`
- `N:1` con **User** (vendedor rese√±ado) ‚Üí `review.seller`
- `N:1` con **OrderItem** (item de orden asociado) ‚Üí `review.orderItem`

**Validaciones:**
- Si `type = PRODUCT`: `productId` es requerido, `sellerId` es null
- Si `type = SELLER`: `sellerId` es requerido, `productId` es null
- `rating` debe estar entre 1 y 5
- Solo se puede rese√±ar un `orderItem` una vez (constraint √∫nico)

**Constraints:**
- Unique constraint en `orderItemId` (solo una rese√±a por compra)
- Check constraint: `rating BETWEEN 1 AND 5`

**Hooks:**
- `@AfterInsert()`: Actualiza el rating promedio y totalReviews del producto/vendedor
- `@AfterUpdate()`: Recalcula el rating promedio
- `@AfterRemove()`: Recalcula el rating promedio

**√çndices:**
- Index en `userId`
- Index en `productId`
- Index en `sellerId`
- Index en `orderItemId` (√∫nico)
- Index en `rating`

---

### üîî 12. **Notification** (Notificaci√≥n)

Notificaciones en tiempo real para los usuarios.

**Atributos:**
```typescript
- id: UUID (PK)
- userId: UUID (FK ‚Üí User, receptor)
- type: enum { 
    NEW_MESSAGE,        // Nuevo mensaje en chat
    NEW_ORDER,          // Nueva orden de compra
    ORDER_STATUS,       // Cambio de estado de orden
    NEW_REVIEW,         // Nueva rese√±a recibida
    PRODUCT_SOLD,       // Tu producto fue vendido
    PRICE_DROP,         // Baj√≥ el precio de favorito
    STOCK_AVAILABLE,    // Producto favorito tiene stock
    REPORT_RESOLVED,    // Tu reporte fue resuelto
    ACCOUNT_WARNING     // Advertencia de cuenta
  }
- title: string (t√≠tulo de la notificaci√≥n, max 100 caracteres)
- message: text (contenido de la notificaci√≥n, max 500 caracteres)
- isRead: boolean (notificaci√≥n le√≠da, default false)
- link: string (URL relacionada, nullable)
- metadata: jsonb (datos adicionales en JSON, nullable)
- createdAt: timestamp (autom√°tico)
```

**Relaciones:**
- `N:1` con **User** (muchas notificaciones pertenecen a un usuario) ‚Üí `notification.user`

**√çndices:**
- Index en `userId`
- Index en `isRead`
- Index en `createdAt`
- Composite index en `(userId, isRead, createdAt)`

**Metadata ejemplos:**
```json
// NEW_MESSAGE
{ "chatId": "uuid", "senderName": "Juan P√©rez" }

// NEW_ORDER
{ "orderId": "uuid", "orderNumber": "ORD-20251018-00001" }

// PRODUCT_SOLD
{ "productId": "uuid", "productTitle": "iPhone 15", "amount": 4500000 }
```

---

### üö© 13. **Report** (Reporte)

Reportes de productos o usuarios problem√°ticos.

**Atributos:**
```typescript
- id: UUID (PK)
- reporterId: UUID (FK ‚Üí User, quien reporta)
- reportedUserId: UUID (FK ‚Üí User, usuario reportado, nullable)
- reportedProductId: UUID (FK ‚Üí Product, producto reportado, nullable)
- type: enum {
    PRODUCT_FAKE,          // Producto falso/falsificado
    PRODUCT_INAPPROPRIATE, // Contenido inapropiado
    PRODUCT_MISLEADING,    // Informaci√≥n enga√±osa
    USER_SCAM,             // Usuario estafador
    USER_HARASSMENT,       // Acoso
    USER_SPAM,             // Spam
    OTHER                  // Otro
  }
- reason: text (descripci√≥n detallada del reporte, min 10 caracteres)
- status: enum { PENDING, UNDER_REVIEW, RESOLVED, DISMISSED }
- adminNote: text (nota del administrador, nullable)
- resolvedAt: timestamp (fecha de resoluci√≥n, nullable)
- resolvedBy: UUID (FK ‚Üí User, admin que resolvi√≥, nullable)
- createdAt: timestamp (autom√°tico)
- updatedAt: timestamp (autom√°tico)
```

**Relaciones:**
- `N:1` con **User** (reportador) ‚Üí `report.reporter`
- `N:1` con **User** (usuario reportado) ‚Üí `report.reportedUser`
- `N:1` con **Product** (producto reportado) ‚Üí `report.reportedProduct`
- `N:1` con **User** (admin resolvedor) ‚Üí `report.resolver`

**Validaciones:**
- Debe tener `reportedUserId` O `reportedProductId` (no ambos, no ninguno)
- `reason` debe tener m√≠nimo 10 caracteres

**Constraints:**
- Check constraint: `(reportedUserId IS NOT NULL AND reportedProductId IS NULL) OR (reportedUserId IS NULL AND reportedProductId IS NOT NULL)`

**√çndices:**
- Index en `reporterId`
- Index en `reportedUserId`
- Index en `reportedProductId`
- Index en `status`
- Index en `createdAt`

**Hooks:**
- `@AfterInsert()`: Crea notificaci√≥n para administradores
- `@AfterUpdate()`: Si status = RESOLVED, crea notificaci√≥n para el reportador

---

## ‚öôÔ∏è ENUMS GLOBALES

### **Role** (Rol de Usuario)
```typescript
enum Role {
  USER = 'user',
  ADMIN = 'admin'
}
```

### **ProductCondition** (Condici√≥n de Producto) ‚úÖ **IMPLEMENTADO**
```typescript
enum ProductCondition {
  NEW = 'new',
  USED = 'used'
}
```

### **OrderStatus** (Estado de Orden)
```typescript
enum OrderStatus {
  PENDING = 'pending',      // Orden creada, pendiente de pago
  PAID = 'paid',            // Pagada
  CANCELLED = 'cancelled',  // Cancelada
  SHIPPED = 'shipped',      // Enviada
  DELIVERED = 'delivered'   // Entregada
}
```

### **PaymentMethod** (M√©todo de Pago)
```typescript
enum PaymentMethod {
  CASH = 'cash',       // Efectivo
  CARD = 'card',       // Tarjeta
  TRANSFER = 'transfer' // Transferencia
}
```

### **ReviewType** (Tipo de Rese√±a)
```typescript
enum ReviewType {
  PRODUCT = 'product',  // Rese√±a de producto
  SELLER = 'seller'     // Rese√±a de vendedor
}
```

### **NotificationType** (Tipo de Notificaci√≥n)
```typescript
enum NotificationType {
  NEW_MESSAGE = 'new_message',
  NEW_ORDER = 'new_order',
  ORDER_STATUS = 'order_status',
  NEW_REVIEW = 'new_review',
  PRODUCT_SOLD = 'product_sold',
  PRICE_DROP = 'price_drop',
  STOCK_AVAILABLE = 'stock_available',
  REPORT_RESOLVED = 'report_resolved',
  ACCOUNT_WARNING = 'account_warning'
}
```

### **ReportType** (Tipo de Reporte)
```typescript
enum ReportType {
  PRODUCT_FAKE = 'product_fake',
  PRODUCT_INAPPROPRIATE = 'product_inappropriate',
  PRODUCT_MISLEADING = 'product_misleading',
  USER_SCAM = 'user_scam',
  USER_HARASSMENT = 'user_harassment',
  USER_SPAM = 'user_spam',
  OTHER = 'other'
}
```

### **ReportStatus** (Estado de Reporte)
```typescript
enum ReportStatus {
  PENDING = 'pending',           // Pendiente
  UNDER_REVIEW = 'under_review', // En revisi√≥n
  RESOLVED = 'resolved',         // Resuelto
  DISMISSED = 'dismissed'        // Desestimado
}
```

---

## üîó DIAGRAMA DE RELACIONES COMPLETO

```
User ‚îÄ‚îÄ‚îÄ‚îÄ1:N‚îÄ‚îÄ‚îÄ‚Üí Product (como vendedor)
User ‚îÄ‚îÄ‚îÄ‚îÄ1:1‚îÄ‚îÄ‚îÄ‚Üí Cart
User ‚îÄ‚îÄ‚îÄ‚îÄ1:N‚îÄ‚îÄ‚îÄ‚Üí Favorite
User ‚îÄ‚îÄ‚îÄ‚îÄ1:N‚îÄ‚îÄ‚îÄ‚Üí Order (como comprador)
User ‚îÄ‚îÄ‚îÄ‚îÄ1:N‚îÄ‚îÄ‚îÄ‚Üí Chat (como buyer/seller)
User ‚îÄ‚îÄ‚îÄ‚îÄ1:N‚îÄ‚îÄ‚îÄ‚Üí Message (como sender)
User ‚îÄ‚îÄ‚îÄ‚îÄ1:N‚îÄ‚îÄ‚îÄ‚Üí Review (como autor) - reviewsGiven
User ‚îÄ‚îÄ‚îÄ‚îÄ1:N‚îÄ‚îÄ‚îÄ‚Üí Review (como vendedor) - reviewsReceived
User ‚îÄ‚îÄ‚îÄ‚îÄ1:N‚îÄ‚îÄ‚îÄ‚Üí Notification (como receptor)
User ‚îÄ‚îÄ‚îÄ‚îÄ1:N‚îÄ‚îÄ‚îÄ‚Üí Report (como reportador)
User ‚îÄ‚îÄ‚îÄ‚îÄ1:N‚îÄ‚îÄ‚îÄ‚Üí Report (como reportado)

Category ‚îÄ1:N‚îÄ‚îÄ‚Üí Product

Product ‚îÄ‚îÄ1:N‚îÄ‚îÄ‚Üí Favorite
Product ‚îÄ‚îÄ1:N‚îÄ‚îÄ‚Üí CartItem
Product ‚îÄ‚îÄ1:N‚îÄ‚îÄ‚Üí OrderItem
Product ‚îÄ‚îÄ1:N‚îÄ‚îÄ‚Üí Chat
Product ‚îÄ‚îÄ1:N‚îÄ‚îÄ‚Üí Review
Product ‚îÄ‚îÄ1:N‚îÄ‚îÄ‚Üí Report

Cart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ1:N‚îÄ‚îÄ‚Üí CartItem

Order ‚îÄ‚îÄ‚îÄ‚îÄ1:N‚îÄ‚îÄ‚Üí OrderItem

OrderItem ‚îÄ1:1‚îÄ‚Üí Review (opcional)

Chat ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ1:N‚îÄ‚îÄ‚Üí Message
```

---

## üìÇ ESTRUCTURA DE CARPETAS PROPUESTA

```
src/
‚îú‚îÄ‚îÄ app.module.ts
‚îú‚îÄ‚îÄ main.ts
‚îú‚îÄ‚îÄ common/
‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ pagination.dto.ts ‚úÖ
‚îÇ   ‚îú‚îÄ‚îÄ helpers/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ currency.helper.ts ‚úÖ
‚îÇ   ‚îú‚îÄ‚îÄ decorators/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ get-user.decorator.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ roles.decorator.ts
‚îÇ   ‚îú‚îÄ‚îÄ guards/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ jwt-auth.guard.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ roles.guard.ts
‚îÇ   ‚îî‚îÄ‚îÄ interceptors/
‚îÇ       ‚îî‚îÄ‚îÄ transform.interceptor.ts
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ database.config.ts
‚îÇ   ‚îî‚îÄ‚îÄ jwt.config.ts
‚îú‚îÄ‚îÄ users/
‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ user.entity.ts
‚îÇ   ‚îú‚îÄ‚îÄ enums/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ role.enum.ts
‚îÇ   ‚îú‚îÄ‚îÄ users.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ users.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ users.module.ts
‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ strategies/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ jwt.strategy.ts
‚îÇ   ‚îú‚îÄ‚îÄ auth.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ auth.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ auth.module.ts
‚îú‚îÄ‚îÄ categories/
‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ category.entity.ts
‚îÇ   ‚îú‚îÄ‚îÄ categories.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ categories.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ categories.module.ts
‚îú‚îÄ‚îÄ products/ ‚úÖ COMPLETADO
‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ create-product.dto.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ update-product.dto.ts
‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ product.entity.ts
‚îÇ   ‚îú‚îÄ‚îÄ enums/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ product-condition.enum.ts
‚îÇ   ‚îú‚îÄ‚îÄ products.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ products.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ products.module.ts
‚îú‚îÄ‚îÄ cart/
‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cart.entity.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ cart-item.entity.ts
‚îÇ   ‚îú‚îÄ‚îÄ cart.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ cart.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ cart.module.ts
‚îú‚îÄ‚îÄ orders/
‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ order.entity.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ order-item.entity.ts
‚îÇ   ‚îú‚îÄ‚îÄ enums/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ order-status.enum.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ payment-method.enum.ts
‚îÇ   ‚îú‚îÄ‚îÄ orders.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ orders.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ orders.module.ts
‚îú‚îÄ‚îÄ favorites/
‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ favorite.entity.ts
‚îÇ   ‚îú‚îÄ‚îÄ favorites.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ favorites.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ favorites.module.ts
‚îú‚îÄ‚îÄ chat/
‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat.entity.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ message.entity.ts
‚îÇ   ‚îú‚îÄ‚îÄ gateways/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ chat.gateway.ts
‚îÇ   ‚îú‚îÄ‚îÄ chat.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ chat.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ chat.module.ts
‚îú‚îÄ‚îÄ reviews/
‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ review.entity.ts
‚îÇ   ‚îú‚îÄ‚îÄ enums/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ review-type.enum.ts
‚îÇ   ‚îú‚îÄ‚îÄ reviews.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ reviews.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ reviews.module.ts
‚îú‚îÄ‚îÄ notifications/
‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ notification.entity.ts
‚îÇ   ‚îú‚îÄ‚îÄ enums/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ notification-type.enum.ts
‚îÇ   ‚îú‚îÄ‚îÄ gateways/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ notifications.gateway.ts
‚îÇ   ‚îú‚îÄ‚îÄ notifications.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ notifications.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ notifications.module.ts
‚îú‚îÄ‚îÄ reports/
‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ report.entity.ts
‚îÇ   ‚îú‚îÄ‚îÄ enums/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ report-type.enum.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ report-status.enum.ts
‚îÇ   ‚îú‚îÄ‚îÄ reports.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ reports.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ reports.module.ts
‚îî‚îÄ‚îÄ seed/ ‚úÖ COMPLETADO
    ‚îú‚îÄ‚îÄ data/
    ‚îÇ   ‚îî‚îÄ‚îÄ products.data.ts
    ‚îú‚îÄ‚îÄ seed.controller.ts
    ‚îú‚îÄ‚îÄ seed.service.ts
    ‚îî‚îÄ‚îÄ seed.module.ts
```

---

## üéØ ESTADO ACTUAL DE IMPLEMENTACI√ìN

### ‚úÖ **Completado (100%):**
1. **Product Entity** - Entidad completa con todos los campos base
2. **ProductCondition Enum** - NEW/USED
3. **Product DTOs** - CreateProductDto, UpdateProductDto con validaciones
4. **Product Service** - CRUD completo (create, findAll, findOne, update, remove)
5. **Product Controller** - Endpoints REST mapeados
6. **Paginaci√≥n** - PaginationDto con limit/offset
7. **Currency Helper** - formatCOP, isValidCOPPrice, parseCOP
8. **Seed Module** - 15 productos iniciales, borra y recrea datos

### üîÑ **Pendiente:**
1. User Entity + Auth Module (JWT)
2. Category Entity
3. Cart + CartItem Entities
4. Order + OrderItem Entities
5. Favorite Entity
6. Chat + Message Entities (WebSockets)
7. Review Entity (sistema de calificaciones)
8. Notification Entity (notificaciones en tiempo real)
9. Report Entity (sistema de reportes)
10. Relaciones entre todas las entidades
11. Roles y permisos (Guards)
12. Subida de im√°genes (Cloudinary/AWS S3)

---

## üöÄ ORDEN DE IMPLEMENTACI√ìN SUGERIDO

### **Fase 1: Autenticaci√≥n y Usuarios** (Prioridad Alta)
1. ‚úÖ Crear Role enum
2. ‚úÖ Crear User entity
3. ‚úÖ Implementar Auth module (registro, login, JWT)
4. ‚úÖ Crear JWT Guards y decoradores
5. ‚úÖ Proteger rutas existentes

### **Fase 2: Categor√≠as y Relaciones de Productos** (Prioridad Alta)
1. ‚úÖ Crear Category entity
2. ‚úÖ Implementar CRUD de categor√≠as
3. ‚úÖ Relacionar Product con User (sellerId)
4. ‚úÖ Relacionar Product con Category (categoryId)
5. ‚úÖ Actualizar seed con categor√≠as y relaciones
6. ‚úÖ Implementar filtros por categor√≠a

### **Fase 3: Carrito de Compras** (Prioridad Media)
1. ‚úÖ Crear Cart entity
2. ‚úÖ Crear CartItem entity
3. ‚úÖ Implementar l√≥gica de carrito (add, remove, update, clear)
4. ‚úÖ Auto-crear carrito al registrar usuario
5. ‚úÖ Validar stock al agregar productos

### **Fase 4: √ìrdenes de Compra** (Prioridad Alta)
1. ‚úÖ Crear OrderStatus enum
2. ‚úÖ Crear PaymentMethod enum
3. ‚úÖ Crear Order entity
4. ‚úÖ Crear OrderItem entity
5. ‚úÖ Implementar proceso de checkout
6. ‚úÖ Actualizar stock al crear orden
7. ‚úÖ Marcar productos como vendidos (isSold)

### **Fase 5: Favoritos** (Prioridad Baja)
1. ‚úÖ Crear Favorite entity
2. ‚úÖ Implementar add/remove favoritos
3. ‚úÖ Endpoint para listar favoritos del usuario

### **Fase 6: Sistema de Mensajer√≠a** (Prioridad Media)
1. ‚úÖ Crear Chat entity
2. ‚úÖ Crear Message entity
3. ‚úÖ Implementar WebSocket Gateway
4. ‚úÖ Eventos en tiempo real (send, typing, read)
5. ‚úÖ Listar chats del usuario
6. ‚úÖ Historial de mensajes

### **Fase 7: Reviews y Ratings** (Prioridad Media)
1. ‚úÖ Crear ReviewType enum
2. ‚úÖ Crear Review entity
3. ‚úÖ Implementar crear rese√±a (solo si compr√≥)
4. ‚úÖ Calcular rating promedio autom√°ticamente
5. ‚úÖ Actualizar rating de Product y User
6. ‚úÖ Validar que solo se rese√±e una vez por compra
7. ‚úÖ Listar reviews de producto/vendedor

### **Fase 8: Sistema de Notificaciones** (Prioridad Media)
1. ‚úÖ Crear NotificationType enum
2. ‚úÖ Crear Notification entity
3. ‚úÖ Implementar WebSocket Gateway para notificaciones
4. ‚úÖ Crear notificaciones autom√°ticas en eventos:
   - Nuevo mensaje
   - Nueva orden (para vendedor)
   - Cambio de estado de orden
   - Nueva rese√±a recibida
   - Producto vendido
5. ‚úÖ Marcar notificaciones como le√≠das
6. ‚úÖ Eliminar notificaciones antiguas (cleanup job)

### **Fase 9: Sistema de Reportes** (Prioridad Baja)
1. ‚úÖ Crear ReportType enum
2. ‚úÖ Crear ReportStatus enum
3. ‚úÖ Crear Report entity
4. ‚úÖ Implementar crear reporte (producto/usuario)
5. ‚úÖ Panel de administraci√≥n para gestionar reportes
6. ‚úÖ Resolver/desestimar reportes
7. ‚úÖ Notificar al reportador cuando se resuelva

### **Fase 10: Mejoras y Optimizaciones** (Prioridad Baja)
1. ‚úÖ Implementar b√∫squeda avanzada (ElasticSearch opcional)
2. ‚úÖ Subida de im√°genes a cloud (Cloudinary/S3)
3. ‚úÖ Cach√© con Redis (productos populares, categor√≠as)
4. ‚úÖ Rate limiting
5. ‚úÖ Logs y monitoreo
6. ‚úÖ Tests unitarios e integraci√≥n
7. ‚úÖ Documentaci√≥n con Swagger

---

## üìä REGLAS DE NEGOCIO IMPORTANTES

### **Productos:**
- ‚úÖ Solo el vendedor puede editar/eliminar su producto
- ‚úÖ No se puede eliminar un producto con √≥rdenes asociadas
- ‚úÖ El stock se descuenta autom√°ticamente al crear una orden
- ‚ùå Un producto con stock = 0 se marca como no disponible
- ‚úÖ Los precios son en COP (pesos colombianos) sin decimales

### **√ìrdenes:**
- ‚úÖ Solo se puede crear orden si hay stock suficiente
- ‚úÖ El precio se congela en OrderItem (snapshot hist√≥rico)
- ‚úÖ El comprador puede cancelar solo si status = PENDING
- ‚úÖ El vendedor puede marcar como SHIPPED/DELIVERED
- ‚úÖ Una orden CANCELLED devuelve el stock al producto

### **Reviews:**
- ‚úÖ Solo se puede rese√±ar si se compr√≥ el producto
- ‚úÖ Solo una rese√±a por compra (orderItemId √∫nico)
- ‚úÖ Rating debe estar entre 1 y 5
- ‚úÖ El rating promedio se calcula autom√°ticamente
- ‚úÖ Se puede editar la rese√±a propia (recalcula rating)

### **Chat:**
- ‚úÖ Solo comprador y vendedor pueden ver el chat
- ‚úÖ No se puede chatear con uno mismo
- ‚úÖ Un chat se asocia a un producto espec√≠fico
- ‚úÖ Los mensajes tienen marca de le√≠do

### **Notificaciones:**
- ‚úÖ Se crean autom√°ticamente en eventos del sistema
- ‚úÖ Se env√≠an en tiempo real v√≠a WebSocket
- ‚úÖ Se pueden marcar como le√≠das
- ‚úÖ Se eliminan autom√°ticamente despu√©s de 30 d√≠as

### **Reportes:**
- ‚úÖ Cualquier usuario puede reportar
- ‚úÖ Solo admins pueden resolver reportes
- ‚úÖ Un reporte puede ser de producto O usuario (no ambos)
- ‚úÖ El reportador recibe notificaci√≥n al resolverse

### **Usuarios:**
- ‚úÖ El rating del vendedor es el promedio de sus reviews recibidas
- ‚úÖ Un usuario puede ser vendedor y comprador simult√°neamente
- ‚úÖ Los admins tienen acceso a panel de reportes y estad√≠sticas

---

## üîí SEGURIDAD Y PERMISOS

### **Autenticaci√≥n:**
- JWT con expiraci√≥n de 7 d√≠as
- Refresh tokens opcionales
- Hash de contrase√±as con bcrypt (salt rounds: 10)

### **Autorizaci√≥n (Guards):**
- `@Public()`: Rutas p√∫blicas (login, registro, ver productos)
- `@Roles('admin')`: Solo administradores
- `@Roles('user', 'admin')`: Usuarios autenticados
- `@IsOwner()`: Solo el due√±o del recurso (custom guard)

### **Validaciones:**
- Whitelist en DTOs (rechazar campos extra)
- Transformaci√≥n autom√°tica de tipos
- Validaci√≥n de UUIDs en params
- Sanitizaci√≥n de inputs

---

## üõ†Ô∏è COMANDOS √öTILES

```bash
# Ejecutar seed de productos
GET http://localhost:3000/seed

# Crear nuevo m√≥dulo completo (CRUD)
nest g resource <nombre> --no-spec

# Crear solo servicio
nest g service <nombre> --no-spec

# Crear solo controlador
nest g controller <nombre> --no-spec

# Crear m√≥dulo
nest g module <nombre>

# Iniciar aplicaci√≥n en desarrollo
npm run start:dev

# Compilar para producci√≥n
npm run build

# Ver logs de PostgreSQL
docker logs shopudenardb

# Entrar a PostgreSQL CLI
docker exec -it shopudenardb psql -U postgres -d TesloDB

# Reiniciar contenedores
docker-compose down
docker-compose up -d
```

---

## üìù NOTAS T√âCNICAS

### **Base de Datos:**
- PostgreSQL 14.3 en Docker
- Puerto: 5433
- Nombre: TesloDB
- Usuario: postgres
- Sincronizaci√≥n autom√°tica: `synchronize: true` (solo desarrollo)

### **Moneda:**
- Todos los precios en **Pesos Colombianos (COP)**
- Sin decimales (DECIMAL(12, 0))
- Validaci√≥n: solo n√∫meros enteros positivos
- Helper de formato: `formatCOP()` ‚Üí "$1.500.000"

### **Identificadores:**
- Todos los IDs son UUID v4
- Generados autom√°ticamente con `@PrimaryGeneratedColumn('uuid')`

### **Timestamps:**
- Todas las entidades tienen `createdAt`
- Entidades editables tienen `updatedAt`
- Autom√°ticos con `@CreateDateColumn()` y `@UpdateDateColumn()`

### **Soft Delete:**
- No implementado actualmente
- Se puede agregar con `@DeleteDateColumn()` en el futuro

### **√çndices:**
- Campos de b√∫squeda frecuente tienen √≠ndices
- Unique constraints en combinaciones √∫nicas
- Composite indexes para queries complejos

---

## üé® ENDPOINTS PRINCIPALES ESPERADOS

### **Auth:**
```
POST   /auth/register
POST   /auth/login
GET    /auth/profile
POST   /auth/refresh
```

### **Users:**
```
GET    /users/:id
PATCH  /users/:id
DELETE /users/:id
GET    /users/:id/products (productos del vendedor)
GET    /users/:id/reviews (rese√±as del vendedor)
```

### **Products:** ‚úÖ
```
GET    /products (paginado, filtros)
GET    /products/:term (UUID o slug)
POST   /products
PATCH  /products/:term
DELETE /products/:id
GET    /products/:id/reviews
```

### **Categories:**
```
GET    /categories
GET    /categories/:id
POST   /categories (admin)
PATCH  /categories/:id (admin)
DELETE /categories/:id (admin)
GET    /categories/:id/products
```

### **Cart:**
```
GET    /cart (mi carrito)
POST   /cart/items (agregar producto)
PATCH  /cart/items/:id (actualizar cantidad)
DELETE /cart/items/:id (eliminar del carrito)
DELETE /cart (vaciar carrito)
```

### **Orders:**
```
GET    /orders (mis √≥rdenes)
GET    /orders/:id
POST   /orders (checkout)
PATCH  /orders/:id/status (cambiar estado)
DELETE /orders/:id (cancelar)
```

### **Favorites:**
```
GET    /favorites (mis favoritos)
POST   /favorites (agregar)
DELETE /favorites/:id (eliminar)
```

### **Chat:**
```
GET    /chats (mis chats)
GET    /chats/:id/messages
POST   /chats (crear chat)
WebSocket: /chat (enviar/recibir mensajes)
```

### **Reviews:**
```
GET    /reviews/product/:productId
GET    /reviews/seller/:sellerId
POST   /reviews (crear rese√±a)
PATCH  /reviews/:id (editar mi rese√±a)
DELETE /reviews/:id (eliminar mi rese√±a)
```

### **Notifications:**
```
GET    /notifications (mis notificaciones)
PATCH  /notifications/:id/read (marcar como le√≠da)
PATCH  /notifications/read-all (marcar todas)
DELETE /notifications/:id
WebSocket: /notifications (tiempo real)
```

### **Reports:**
```
GET    /reports (admin: todos, user: mis reportes)
GET    /reports/:id (detalle)
POST   /reports (crear reporte)
PATCH  /reports/:id/resolve (admin)
PATCH  /reports/:id/dismiss (admin)
```

### **Seed:** ‚úÖ
```
GET    /seed (ejecutar seed)
```

---

## üéØ PR√ìXIMOS PASOS INMEDIATOS

**Opci√≥n 1: Implementar Auth + Users** (Recomendado para funcionalidad completa)
- Permitir√° proteger rutas y asociar productos a vendedores
- Base para todas las dem√°s funcionalidades

**Opci√≥n 2: Implementar Categories**
- Complementa el m√≥dulo de productos
- Permite organizar el marketplace

**Opci√≥n 3: Agregar relaciones a Product**
- Conectar productos con vendedores y categor√≠as
- Actualizar seed con datos relacionales

---

**¬øCon qu√© m√≥dulo quieres continuar?** üöÄ
